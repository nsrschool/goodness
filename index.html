<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô - ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2568 (Online)</title>
    <style>
        /* CSS for the application styling */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Sarabun', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(45deg, #2196F3, #21CBF3); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .connection-status { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 14px; transition: all 0.3s; display: inline-block; }
        .status-online { color: #00ff88; border: 1px solid #00ff88; }
        .status-offline { color: #ff6b6b; border: 1px solid #ff6b6b; }
        .nav-tabs { display: flex; flex-wrap: wrap; background: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .nav-tab { flex: 1; padding: 15px; text-align: center; background: #e9ecef; border: none; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; min-width: 120px; }
        .nav-tab.active { background: white; color: #2196F3; border-bottom: 3px solid #2196F3; }
        .nav-tab:hover { background: #f1f3f5; }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .tab-content.active { display: block; }
        .main-grid, .student-grid, .items-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; margin-bottom: 30px; }
        .form-section, .records-section, .list-section { background: #f8f9fa; padding: 25px; border-radius: 10px; border: 1px solid #e9ecef; }
        .form-section h2, .records-section h2, .list-section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5em; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #34495e; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; font-family: 'Sarabun', sans-serif; }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
        .activity-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .activity-btn { padding: 15px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; text-align: center; font-weight: bold; }
        .activity-btn:hover { background: #e8f4fd; border-color: #3498db; }
        .activity-btn.active { background: #3498db; color: white; border-color: #2980b9; }
        .submit-btn { width: 100%; padding: 15px; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }
        .submit-btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; }
        .loading { display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #ecf0f1; transition: transform 0.3s, box-shadow 0.3s; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #2c3e50; }
        .stat-label { color: #7f8c8d; margin-top: 5px; }
        .records-table, .student-list-table, .items-table { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #ecf0f1; max-height: 500px; overflow-y: auto; display: block; }
        .records-table table, .student-list-table table, .items-table table { width: 100%; border-collapse: collapse; }
        .records-table th, .student-list-table th, .items-table th { background: #34495e; color: white; padding: 15px 10px; text-align: left; font-weight: bold; position: sticky; top: 0; z-index: 1;}
        .records-table td, .student-list-table td, .items-table td { padding: 12px 10px; border-bottom: 1px solid #ecf0f1; vertical-align: middle; }
        .records-table tr:hover, .student-list-table tr:hover, .items-table tr:hover { background: #f8f9fa; }
        .score-badge { background: #3498db; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 0.9em; }
        .activity-tag { background: #e74c3c; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; font-weight: bold; display: inline-block; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 0.9em; color: white; }
        .status-remaining { background: #e67e22; }
        .status-claimed { background: #27ae60; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .alert-container { position: fixed; top: 20px; right: 20px; z-index: 1050; width: 300px; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 10px; opacity: 1; transition: opacity 0.5s, transform 0.5s; transform: translateX(0); color: white; }
        .alert.hide { opacity: 0; transform: translateX(20px); }
        .alert-success { background: #2ecc71; }
        .alert-danger { background: #e74c3c; }
        .alert-warning { background: #f39c12; }
        .alert-info { background: #3498db; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .reports-tab .form-section { background-color: #f8f9fa; }
        .top-students { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .student-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: all 0.3s; position: relative; overflow: hidden; }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
        .student-rank { position: absolute; top: 10px; left: 10px; background: #3498db; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; }
        .student-name { font-size: 1.3em; font-weight: bold; color: #2c3e50; margin-top: 20px; margin-bottom: 10px; }
        .student-score { font-size: 1.8em; color: #27ae60; font-weight: bold; }
        @media (max-width: 992px) { .main-grid, .student-grid, .items-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .nav-tabs { flex-direction: column; } .stats-grid { grid-template-columns: 1fr; } .activity-buttons { grid-template-columns: 1fr; } .header h1 { font-size: 2em; } .alert-container { width: 90%; right: 5%; } }
    </style>
</head>
<body>
    <div id="alertContainer" class="alert-container"></div>
    <div class="container">
        <div class="header">
            <h1>üèÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô</h1>
            <p>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2568 - ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏° (Online)</p>
            <div class="connection-status" id="connectionStatus">
                <span id="statusIcon">üîÑ</span> <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            </div>
            <div id="header-instruction" style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 13px;">
                üí° ‡∏´‡∏≤‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab(event, 'record-tab')">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</button>
            <button class="nav-tab" onclick="showTab(event, 'items-tab')">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á</button>
            <button class="nav-tab" onclick="showTab(event, 'students-tab')">üßë‚Äçüéì ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <button class="nav-tab" onclick="showTab(event, 'reports-tab')">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</button>
        </div>

        <!-- Tab: Record Deed -->
        <div id="record-tab" class="tab-content active">
            <div class="main-grid">
                <div class="form-section">
                    <h2 id="form-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</h2>
                    <form id="goodDeedForm">
                         <input type="hidden" id="editingTimestamp" value="">
                        <div class="form-group">
                            <label for="studentSearch">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ):</label>
                            <input type="text" id="studentSearch" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="margin-bottom: 10px;">
                            <select id="studentSelect" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="dateInput">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="dateInput" required></div>
                        <div class="form-group">
                            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                            <div class="activity-buttons">
                                <button type="button" class="activity-btn" data-activity="lost-found">üì¶ ‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                                <button type="button" class="activity-btn" data-activity="money-found">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                                <button type="button" class="activity-btn" data-activity="trash-pickup">üóëÔ∏è ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞</button>
                                <button type="button" class="activity-btn" data-activity="help-teacher">üë©‚Äçüè´ ‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π</button>
                                <button type="button" class="activity-btn" data-activity="other-good">‚ú® ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
                            </div>
                        </div>
                        <div class="form-group" id="itemDescriptionGroup" style="display: none;"><label for="itemDescription">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö:</label><input type="text" id="itemDescription" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏™‡∏µ‡∏î‡∏≥, ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡∏¥‡∏ô‡∏™‡∏≠"></div>
                        <div class="form-group" id="moneyAmountGroup" style="display: none;"><label for="moneyAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó):</label><input type="number" id="moneyAmount" min="0" step="0.01" placeholder="0.00"></div>
                        <div class="form-group"><label for="description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label><textarea id="description" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πà‡∏ô..."></textarea></div>
                        <div class="form-group"><label for="pointsInput">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</label><input type="number" id="pointsInput" min="1" value="5"></div>
                        <button type="submit" class="submit-btn" id="submitBtn"><span class="loading spinner"></span><span class="btn-text">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</span></button>
                        <button type="button" class="btn" id="cancelEditBtn" style="width: 100%; margin-top: 10px; background: #7f8c8d; color: white; display: none;" onclick="cancelEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </form>
                </div>
                <div class="records-section">
                    <h2>üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-number" id="totalRecords">0</div><div class="stat-label">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalPoints">0</div><div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div></div>
                        <div class="stat-card"><div class="stat-number" id="totalStudents">0</div><div class="stat-label">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏à‡∏≤‡∏Å Sheet)</div></div>
                        <div class="stat-card"><div class="stat-number" id="todayRecords">0</div><div class="stat-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div>
                    </div>
                    <div class="records-table">
                        <table>
                            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="recordsTableBody"><tr><td colspan="5" style="text-align: center; color: #7f8c8d; padding: 30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Items -->
        <div id="items-tab" class="tab-content">
            <div class="items-grid">
                <div class="list-section">
                    <h2>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                    <div class="items-table">
                        <table id="remainingItemsTable">
                            <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö</th><th>‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö</th><th>‡∏ú‡∏π‡πâ‡∏û‡∏ö</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="remainingItemsBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="list-section">
                    <h2>‚úÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <div class="items-table">
                        <table id="claimedItemsTable">
                             <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</th><th>‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏û‡∏ö‡πÄ‡∏î‡∏¥‡∏°</th></tr></thead>
                            <tbody id="claimedItemsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Student Management -->
        <div id="students-tab" class="tab-content">
            <div class="student-grid">
                <div class="form-section">
                    <h2>üßë‚Äçüéì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                    <form id="addStudentForm">
                        <div class="form-group"><label for="studentClass">‡∏ä‡∏±‡πâ‡∏ô:</label><input type="text" id="studentClass" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.1/1" required></div>
                        <div class="form-group"><label for="studentNumber">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label><input type="number" id="studentNumber" min="1" required></div>
                        <div class="form-group"><label for="studentPrefix">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</label><input type="text" id="studentPrefix" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢, ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" required></div>
                        <div class="form-group"><label for="studentFirstName">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á:</label><input type="text" id="studentFirstName" required></div>
                        <div class="form-group"><label for="studentLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label><input type="text" id="studentLastName" required></div>
                        <button type="submit" class="submit-btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </form>
                    <hr style="margin: 30px 0; border-color: #dee2e6;">
                    <h2>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å Excel</h2>
                     <div class="alert alert-warning" style="color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; margin-bottom: 15px;">
                        <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö:
                        <br>A: ‡∏ä‡∏±‡πâ‡∏ô, B: ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, C: ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤, D: ‡∏ä‡∏∑‡πà‡∏≠, E: ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
                    </div>
                    <div class="form-group">
                        <label for="excelFileInput">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx):</label>
                        <input type="file" id="excelFileInput" class="form-control" accept=".xlsx, .xls" style="padding: 5px;">
                    </div>
                    <button id="importExcelBtn" class="btn btn-success" style="width: 100%;">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel</button>
                </div>
                <div class="list-section">
                    <h2>üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <div class="student-list-table">
                        <table id="studentListTable">
                            <thead><tr><th>‡∏ä‡∏±‡πâ‡∏ô</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="studentListBody"><tr><td colspan="4" style="text-align: center; color: #7f8c8d; padding: 30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Reports -->
        <div id="reports-tab" class="tab-content">
            <div class="form-section">
                <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px;">
                    <h2>üèÖ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° TOP 10</h2>
                    <div>
                        <button onclick="syncData()" class="btn btn-primary">üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button onclick="exportToExcel()" class="btn btn-success">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
                        <button onclick="printReport()" class="btn btn-primary">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>
                <div class="top-students" id="topStudents"><div style="grid-column: 1 / -1; text-align: center; color: #7f8c8d; padding: 30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°...</div></div>
            </div>
             <div class="form-section" style="margin-top: 20px;">
                <h2>üìã ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
                <div style="background: #e9f7fd; border: 1px solid #d0ebf9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #0c5460; margin-bottom: 15px;">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô):</h3>
                    <ul style="color: #31708f; margin: 0; padding-left: 20px;">
                        <li><strong>‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô:</strong> 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</li>
                        <li><strong>‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô:</strong> 1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≠ 5 ‡∏ö‡∏≤‡∏ó (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</li>
                        <li><strong>‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞:</strong> 3 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</li>
                        <li><strong>‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π:</strong> 4 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</li>
                        <li><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ:</strong> 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ)</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for prompts -->
    <div id="customModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; text-align: center;">
            <p id="modalMessage" style="margin-bottom: 20px; font-size: 16px;"></p>
            <input type="text" id="modalInput" style="width: calc(100% - 24px); padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px;">
            <button id="modalConfirmBtn" class="btn btn-primary">‡∏ï‡∏Å‡∏•‡∏á</button>
            <button id="modalCancelBtn" class="btn" style="background: #ccc;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // --- CONFIGURATION ---
        // VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV
        // VVV   ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á GOOGLE APPS SCRIPT WEB APP URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà   VVV
        // VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbwGY2vzGCaVujOMU8HIrbqAef8vzU2PtImYjSzf6vCFO2Ixcf11iM-7z9YgUcI6e7yg/exec';
        // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


        // --- GLOBAL VARIABLES ---
        let allStudents = [];
        let goodDeedRecords = [];
        let allItems = [];
        let studentScores = {};
        let isOnline = false;
        let apiClient = null;
        let modalCallback = null;

        // --- CONSTANTS ---
        const activityPoints = { 'lost-found': 5, 'money-found': 0, 'trash-pickup': 3, 'help-teacher': 4, 'other-good': 5 };
        const activityNames = { 'lost-found': '‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô', 'money-found': '‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô', 'trash-pickup': '‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞', 'help-teacher': '‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π', 'other-good': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ' };

        // --- SAFE UI HELPER ---
        function safeSetText(id, text) {
            const element = document.getElementById(id);
            if (element) element.textContent = text;
        }

        // --- APPS SCRIPT API CLIENT ---
        class AppsScriptAPI {
            constructor(url) { this.url = url; }
            async get(action) {
                const response = await fetch(`${this.url}?action=${action}`, { method: 'GET', redirect: 'follow' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                return result.data;
            }
            async post(action, payload) {
                const response = await fetch(this.url, { method: 'POST', body: JSON.stringify({ action, data: payload }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }, redirect: 'follow' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                return result;
            }
        }

        // --- INITIALIZATION ---
        async function initializeApp() {
            if (!webAppUrl || webAppUrl === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                updateConnectionStatus(false, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô', 'danger', 10000);
                document.getElementById('header-instruction').style.display = 'block';
                return;
            }

            document.getElementById('header-instruction').style.display = 'none';
            apiClient = new AppsScriptAPI(webAppUrl);
            
            try {
                await apiClient.get('getRecords'); // Test connection
                isOnline = true;
                updateConnectionStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                await loadAllData();
            } catch (error) {
                isOnline = false;
                updateConnectionStatus(false, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á Apps Script', 'danger');
                document.getElementById('header-instruction').style.display = 'block';
            }
        }

        function updateConnectionStatus(connected, message) {
            const connectionStatusDiv = document.getElementById('connectionStatus');
            safeSetText('statusIcon', connected ? 'üü¢' : 'üî¥');
            safeSetText('statusText', `${connected ? 'Online' : 'Offline'} - ${message}`);
            if (connectionStatusDiv) connectionStatusDiv.className = connected ? 'connection-status status-online' : 'connection-status status-offline';
        }

        // --- DATA HANDLING ---
        async function loadAllData() {
            if (!apiClient || !isOnline) return;
            showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            try {
                const [studentsData, recordsData, itemsData] = await Promise.all([
                    apiClient.get('getStudents'), apiClient.get('getRecords'), apiClient.get('getItems')
                ]);
                allStudents = studentsData.length > 1 ? studentsData.slice(1).map(row => ({ class: row[0] || '', number: parseInt(row[1]) || 0, prefix: row[2] || '', firstName: row[3] || '', lastName: row[4] || '', fullName: `${row[2] || ''}${row[3] || ''} ${row[4] || ''}`.trim() })) : [];
                goodDeedRecords = recordsData.length > 1 ? recordsData.slice(1).map(row => ({ date: row[0] || '', studentName: row[1] || '', activityName: row[2] || '', description: row[3] || '', points: parseInt(row[4]) || 0, timestamp: row[5] || '' })) : [];
                allItems = itemsData.length > 1 ? itemsData.slice(1).map(row => ({ timestamp: row[0], type: row[1], description: row[2], dateFound: row[3], foundBy: row[4], status: row[5], claimedBy: row[6], dateClaimed: row[7] })) : [];
                
                studentScores = {};
                goodDeedRecords.forEach(record => { studentScores[record.studentName] = (studentScores[record.studentName] || 0) + record.points; });

                updateDisplay();
                showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                showAlert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'danger');
                updateConnectionStatus(false, '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            }
        }
        async function syncData() {
            if (!isOnline) { showAlert('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡∏π‡πà ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏î‡πâ', 'warning'); return; }
            await loadAllData();
        }

        // --- STUDENT MANAGEMENT ---
        function setupStudentManagement() {
            document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!isOnline) { showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô', 'danger'); return; }
                const newStudent = [ document.getElementById('studentClass').value.trim(), document.getElementById('studentNumber').value, document.getElementById('studentPrefix').value.trim(), document.getElementById('studentFirstName').value.trim(), document.getElementById('studentLastName').value.trim() ];
                if (newStudent.some(field => !field)) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning'); return; }
                showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...', 'info');
                try {
                    await apiClient.post('addStudent', newStudent);
                    showAlert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    e.target.reset();
                    await loadAllData();
                } catch (error) { showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger'); }
            });
            document.getElementById('studentListBody').addEventListener('click', async (e) => {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    const fullName = e.target.dataset.name;
                    const confirmed = await customConfirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "${fullName}"?`);
                    if (!confirmed) return;
                    showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...', 'info');
                    try {
                        await apiClient.post('deleteStudent', { fullName });
                        showAlert(`‡∏•‡∏ö ${fullName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                        await loadAllData();
                    } catch (error) { showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger'); }
                }
            });
            document.getElementById('importExcelBtn').addEventListener('click', handleExcelImport);
        }
        async function handleExcelImport() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];
            if (!file) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô', 'warning'); return; }
            if (!isOnline) { showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô', 'danger'); return; }
            showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel...', 'info');
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    const studentsToImport = jsonData.filter(row => row.length >= 5 && row.slice(0, 5).some(cell => cell !== null && String(cell).trim() !== ''));
                    if (studentsToImport.length === 0) { showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel', 'warning'); return; }
                    showAlert(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${studentsToImport.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...`, 'info');
                    await apiClient.post('addMultipleStudents', studentsToImport);
                    showAlert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô`, 'success');
                    fileInput.value = '';
                    await loadAllData();
                } catch (error) { showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå: ' + error.message, 'danger'); }
            };
            reader.onerror = () => { showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'danger'); };
            reader.readAsArrayBuffer(file);
        }
        function renderStudentManagementList() {
            const tbody = document.getElementById('studentListBody');
            if (!tbody) return;
            if (allStudents.length === 0) { tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>`; return; }
            const sorted = [...allStudents].sort((a,b) => (a.class || '').localeCompare(b.class || '', 'th') || (a.number || 0) - (b.number || 0));
            tbody.innerHTML = sorted.map(s => `<tr><td>${s.class}</td><td>${s.number}</td><td>${s.fullName}</td><td><button class="btn btn-danger btn-sm delete-btn" data-name="${s.fullName}">‡∏•‡∏ö</button></td></tr>`).join('');
        }

        // --- UI LOGIC & EVENT LISTENERS ---
        function showAlert(message, type = 'info', duration = 4000) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            container.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.classList.add('hide');
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            }, duration);
        }
        function populateStudentSelect(students) {
            const studentSelect = document.getElementById('studentSelect');
            if(!studentSelect) return;
            const currentVal = studentSelect.value;
            studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
            const sorted = [...students].sort((a,b) => (a.class || '').localeCompare(b.class || '', 'th') || (a.number || 0) - (b.number || 0));
            let currentClass = '';
            let optgroup = null;
            sorted.forEach(s => {
                if (s.class !== currentClass) {
                    if (optgroup) studentSelect.appendChild(optgroup);
                    optgroup = document.createElement('optgroup');
                    optgroup.label = `‡∏ä‡∏±‡πâ‡∏ô ${s.class}`;
                    currentClass = s.class;
                }
                const option = document.createElement('option');
                option.value = s.fullName;
                option.textContent = `${s.number}. ${s.fullName}`;
                if(optgroup) optgroup.appendChild(option);
            });
            if (optgroup) studentSelect.appendChild(optgroup);
            studentSelect.value = currentVal;
        }
        function setupGoodDeedForm() {
            const form = document.getElementById('goodDeedForm');
            if(!form) return;
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!isOnline) { showAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô', 'danger'); return; }
                const studentName = document.getElementById('studentSelect').value;
                const activeBtn = document.querySelector('.activity-btn.active');
                if (!studentName || !activeBtn) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)', 'warning'); return; }
                
                const submitBtn = document.getElementById('submitBtn');
                const btnText = submitBtn.querySelector('.btn-text');
                const loading = submitBtn.querySelector('.loading');
                const editingTimestamp = document.getElementById('editingTimestamp').value;
                const activityType = activeBtn.dataset.activity;
                
                const itemDescription = document.getElementById('itemDescription').value.trim();
                const moneyAmount = document.getElementById('moneyAmount').value;

                if (activityType === 'lost-found' && !itemDescription) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö"', 'warning'); return; }
                if (activityType === 'money-found' && (!moneyAmount || parseFloat(moneyAmount) <= 0)) { showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning'); return; }

                submitBtn.disabled = true;
                loading.style.display = 'block';
                btnText.textContent = editingTimestamp ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
                const points = parseInt(document.getElementById('pointsInput').value);
                const timestamp = editingTimestamp || new Date().toISOString();
                const recordData = [ document.getElementById('dateInput').value, studentName, activityNames[activityType], document.getElementById('description').value, points, timestamp ];
                
                try {
                    if (editingTimestamp) {
                        await apiClient.post('editRecord', { timestamp: editingTimestamp, newRecord: recordData });
                    } else {
                        await apiClient.post('appendRecord', recordData);
                        if (activityType === 'lost-found' || activityType === 'money-found') {
                            const itemData = [ timestamp, activityType === 'money-found' ? '‡πÄ‡∏á‡∏¥‡∏ô' : '‡∏Ç‡∏≠‡∏á', activityType === 'money-found' ? moneyAmount : itemDescription, recordData[0], studentName, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '', '' ];
                            await apiClient.post('logItemFound', itemData);
                        }
                    }
                    showAlert(editingTimestamp ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    cancelEdit();
                    await loadAllData();
                } catch (error) { showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger');
                } finally {
                    submitBtn.disabled = false;
                    loading.style.display = 'none';
                }
            });
        }
        async function handleRecordActions(e) {
            const target = e.target;
            const timestamp = target.dataset.timestamp;
            if (!timestamp) return;

            if (target.classList.contains('edit-btn')) {
                const recordToEdit = goodDeedRecords.find(r => r.timestamp == timestamp);
                if (recordToEdit) {
                    document.getElementById('editingTimestamp').value = recordToEdit.timestamp;
                    document.getElementById('dateInput').value = new Date(recordToEdit.date).toISOString().split('T')[0];
                    document.getElementById('studentSelect').value = recordToEdit.studentName;
                    document.getElementById('description').value = recordToEdit.description;
                    document.getElementById('pointsInput').value = recordToEdit.points;
                    
                    document.querySelectorAll('.activity-btn').forEach(btn => {
                        const activityKey = Object.keys(activityNames).find(key => activityNames[key] === recordToEdit.activityName);
                        btn.classList.toggle('active', btn.dataset.activity === activityKey);
                        if(btn.classList.contains('active')){
                            const relatedItem = allItems.find(item => item.timestamp === recordToEdit.timestamp);
                            if (btn.dataset.activity === 'lost-found') {
                                document.getElementById('itemDescriptionGroup').style.display = 'block';
                                document.getElementById('itemDescription').value = relatedItem ? relatedItem.description : '';
                            } else if (btn.dataset.activity === 'money-found') {
                                document.getElementById('moneyAmountGroup').style.display = 'block';
                                document.getElementById('moneyAmount').value = relatedItem ? relatedItem.description : '';
                            }
                        }
                    });
                    
                    document.getElementById('form-title').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ';
                    document.querySelector('#submitBtn .btn-text').textContent = 'üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    document.getElementById('cancelEditBtn').style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else if (target.classList.contains('delete-btn')) {
                const confirmed = await customConfirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ? (‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢)`);
                if (confirmed) deleteRecord(timestamp);
            }
        }
        async function deleteRecord(timestamp) {
            showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            try {
                await apiClient.post('deleteRecord', { timestamp });
                showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                await loadAllData();
            } catch (error) { showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + error.message, 'danger'); }
        }
        function cancelEdit() {
            document.getElementById('goodDeedForm').reset();
            document.getElementById('editingTimestamp').value = '';
            document.getElementById('form-title').textContent = 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ';
            document.querySelector('#submitBtn .btn-text').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('itemDescriptionGroup').style.display = 'none';
            document.getElementById('moneyAmountGroup').style.display = 'none';
            setCurrentDate();
        }
        function updateDisplay() {
            updateStats();
            updateRecordsTable();
            updateTopStudents();
            populateStudentSelect(allStudents);
            renderStudentManagementList();
            renderItemsTables();
        }
        function updateStats() {
            safeSetText('totalRecords', goodDeedRecords.length);
            safeSetText('totalPoints', Object.values(studentScores).reduce((s, c) => s + c, 0).toLocaleString());
            safeSetText('totalStudents', allStudents.length);
            safeSetText('todayRecords', goodDeedRecords.filter(r => r.date === new Date().toISOString().split('T')[0]).length);
        }
        function updateRecordsTable() {
            const tbody = document.getElementById('recordsTableBody');
            if(!tbody) return;
            if (goodDeedRecords.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 30px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }
            tbody.innerHTML = [...goodDeedRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 100)
                .map(r => {
                    const isItemRelated = r.activityName === '‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô' || r.activityName === '‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô';
                    const itemStatus = isItemRelated ? allItems.find(item => item.timestamp === r.timestamp)?.status : null;
                    const canEdit = !isItemRelated || itemStatus === '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
                    return `<tr>
                        <td>${new Date(r.date).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric'})}</td>
                        <td>${r.studentName}</td>
                        <td><span class="activity-tag">${r.activityName}</span> ${r.description ? `<br><small style="color: #555;">${r.description}</small>` : ''}</td>
                        <td><span class="score-badge">${r.points}</span></td>
                        <td>
                            ${canEdit ? `<button class="btn btn-warning btn-sm edit-btn" data-timestamp="${r.timestamp}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ''}
                            <button class="btn btn-danger btn-sm delete-btn" data-timestamp="${r.timestamp}">‡∏•‡∏ö</button>
                        </td>
                    </tr>`;
                }).join('');
        }
        function updateTopStudents() {
            const div = document.getElementById('topStudents');
            if(!div) return;
            if (Object.keys(studentScores).length === 0) { div.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 30px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>`; return; }
            const sorted = Object.entries(studentScores).sort((a, b) => b[1] - a[1]).slice(0, 10);
            div.innerHTML = sorted.map(([name, score], i) => `<div class="student-card"><div class="student-rank">${i + 1}</div><div class="student-name">${name}</div><div class="student-score">${score.toLocaleString()} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div></div>`).join('');
        }
        function showTab(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            if(tabId !== 'record-tab') cancelEdit();
        }
        function setupSearch() {
            const searchInput = document.getElementById('studentSearch');
            if(searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    const filtered = !searchTerm ? allStudents : allStudents.filter(s => `${s.class} ${s.fullName}`.toLowerCase().includes(searchTerm));
                    populateStudentSelect(filtered);
                });
            }
        }
        function setCurrentDate() {
            const dateInput = document.getElementById('dateInput');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
        }
        function setupActivityButtons() {
            const activityBtns = document.querySelectorAll('.activity-btn');
            const moneyGroup = document.getElementById('moneyAmountGroup');
            const itemGroup = document.getElementById('itemDescriptionGroup');
            const pointsInput = document.getElementById('pointsInput');
            const moneyInput = document.getElementById('moneyAmount');
            activityBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    activityBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const activity = this.dataset.activity;
                    moneyGroup.style.display = activity === 'money-found' ? 'block' : 'none';
                    itemGroup.style.display = activity === 'lost-found' ? 'block' : 'none';
                    if (activity === 'money-found') {
                        pointsInput.value = 1;
                        moneyInput.value = '';
                    } else {
                        pointsInput.value = activityPoints[activity] || 5;
                    }
                });
            });
            if(moneyInput) {
                moneyInput.addEventListener('input', function() {
                    if(document.querySelector('.activity-btn[data-activity="money-found"].active')) {
                       if(pointsInput) pointsInput.value = Math.max(1, Math.floor(parseFloat(this.value) || 0) / 5);
                    }
                });
            }
        }
        function renderItemsTables() {
            const remainingBody = document.getElementById('remainingItemsBody');
            const claimedBody = document.getElementById('claimedItemsBody');
            if (!remainingBody || !claimedBody) return;

            const remainingItems = allItems.filter(item => item.status === '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠').sort((a,b) => new Date(b.dateFound) - new Date(a.dateFound));
            const claimedItems = allItems.filter(item => item.status === '‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß').sort((a,b) => new Date(b.dateClaimed) - new Date(a.dateClaimed));

            remainingBody.innerHTML = remainingItems.length > 0 ? remainingItems.map(item => `
                <tr>
                    <td>${new Date(item.dateFound).toLocaleDateString('th-TH')}</td>
                    <td>${item.type === '‡πÄ‡∏á‡∏¥‡∏ô' ? `${parseFloat(item.description).toLocaleString()} ‡∏ö‡∏≤‡∏ó` : item.description}</td>
                    <td>${item.foundBy}</td>
                    <td><button class="btn btn-success btn-sm claim-btn" data-timestamp="${item.timestamp}">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</button></td>
                </tr>
            `).join('') : `<tr><td colspan="4" style="text-align:center; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</td></tr>`;

            claimedBody.innerHTML = claimedItems.length > 0 ? claimedItems.map(item => `
                <tr>
                    <td>${new Date(item.dateClaimed).toLocaleDateString('th-TH')}</td>
                    <td>${item.type === '‡πÄ‡∏á‡∏¥‡∏ô' ? `${parseFloat(item.description).toLocaleString()} ‡∏ö‡∏≤‡∏ó` : item.description}</td>
                    <td>${item.claimedBy}</td>
                    <td>${item.foundBy}</td>
                </tr>
            `).join('') : `<tr><td colspan="4" style="text-align:center; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</td></tr>`;
        }
        async function handleItemClaim(e) {
            if (e.target && e.target.classList.contains('claim-btn')) {
                const timestamp = e.target.dataset.timestamp;
                const claimedBy = await customPrompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô:");
                if (claimedBy && claimedBy.trim() !== '') {
                    showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô...', 'info');
                    try {
                        await apiClient.post('claimItem', {
                            timestamp: timestamp,
                            claimedBy: claimedBy.trim(),
                            claimedDate: new Date().toISOString().split('T')[0]
                        });
                        showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                        await loadAllData();
                    } catch (error) { showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger'); }
                }
            }
        }
        function exportToExcel() {
            if (goodDeedRecords.length === 0 && allItems.length === 0) { showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'warning'); return; }
            const wb = XLSX.utils.book_new();
            
            const recordsWS = XLSX.utils.json_to_sheet(goodDeedRecords.map(r => ({ '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': r.date, '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': r.studentName, '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°': r.activityName, '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': r.description, '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô': r.points, 'Timestamp': r.timestamp })));
            XLSX.utils.book_append_sheet(wb, recordsWS, '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ');

            const itemsWS = XLSX.utils.json_to_sheet(allItems.map(i => ({ 'Timestamp': i.timestamp, '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': i.type, '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô': i.description, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö': i.dateFound, '‡∏ú‡∏π‡πâ‡∏û‡∏ö': i.foundBy, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': i.status, '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô': i.claimedBy, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô': i.dateClaimed })));
            XLSX.utils.book_append_sheet(wb, itemsWS, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');

            const scoresWS = XLSX.utils.json_to_sheet(Object.entries(studentScores).sort((a,b)=>b[1]-a[1]).map(([n,s],i)=>({'‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö':i+1, '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•':n, '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°':s})));
            XLSX.utils.book_append_sheet(wb, scoresWS, '‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô');

            XLSX.writeFile(wb, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ-${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.xlsx`);
        }
        function printReport() {
            const printWindow = window.open('', '_blank');
            const totalPoints = Object.values(studentScores).reduce((s, c) => s + c, 0);
            const printContent = `<!DOCTYPE html><html lang="th"><head><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</title><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family: 'Sarabun', sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd; padding:8px;} h1,h2{text-align:center;}</style></head><body><h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</h1><p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå:</strong> ${new Date().toLocaleDateString('th-TH', {dateStyle: 'full'})}</p><p><strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${goodDeedRecords.length} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p><p><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${totalPoints.toLocaleString()} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p><h2>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h2><table><thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th></tr></thead><tbody>${Object.entries(studentScores).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([n,s],i)=>`<tr><td>${i+1}</td><td>${n}</td><td>${s.toLocaleString()}</td></tr>`).join('')}</tbody></table></body></html>`;
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // --- Custom Modals ---
        function showModal(message, type = 'confirm') {
            const modal = document.getElementById('customModal');
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalInput').style.display = type === 'prompt' ? 'block' : 'none';
            if (type === 'prompt') document.getElementById('modalInput').value = '';
            modal.style.display = 'block';
        }
        function hideModal() {
            document.getElementById('customModal').style.display = 'none';
            if (modalCallback) modalCallback = null;
        }
        function customConfirm(message) {
            return new Promise(resolve => {
                showModal(message, 'confirm');
                modalCallback = (result) => resolve(result);
            });
        }
        function customPrompt(message) {
            return new Promise(resolve => {
                showModal(message, 'prompt');
                modalCallback = (result) => resolve(result);
            });
        }
        
        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setCurrentDate();
            setupSearch();
            setupActivityButtons();
            setupGoodDeedForm();
            setupStudentManagement();
            document.getElementById('recordsTableBody').addEventListener('click', handleRecordActions);
            document.getElementById('remainingItemsBody').addEventListener('click', handleItemClaim);
            
            // Modal listeners
            document.getElementById('modalConfirmBtn').addEventListener('click', () => {
                const input = document.getElementById('modalInput');
                const result = input.style.display === 'none' ? true : input.value;
                if (modalCallback) modalCallback(result);
                hideModal();
            });
            document.getElementById('modalCancelBtn').addEventListener('click', () => {
                if (modalCallback) modalCallback(false);
                hideModal();
            });

            updateDisplay();
        });
    </script>
</body>
</html>
